# 🎲 随机搜索优化 - 完整测试样例

## 📖 功能说明

随机搜索是一种自动化 Prompt 优化算法，通过以下步骤找到最优 Prompt：

1. **参数化分解**：将 Prompt 拆解为可变组件（角色、风格、技巧）
2. **随机组合**：生成多个不同的 Prompt 变体
3. **实战评估**：在测试集上实际运行并打分
4. **优胜劣汰**：自动选出得分最高的 Prompt

---

## 🧪 测试样例 1：情感分类任务

### 配置信息

**任务类型**：`classification`（分类任务）

**任务描述**：
```
对用户评论进行情感分类，判断为积极、消极或中立
```

**测试数据集**（至少3条）：

| 测试输入 | 标准答案 |
|---------|---------|
| 这个产品真的很好用，非常满意！ | 积极 |
| 价格太贵了，性价比不高，不推荐购买 | 消极 |
| 还可以吧，没什么特别的感觉 | 中立 |
| 质量很差，用了一次就坏了 | 消极 |
| 物流很快，包装也很好，赞一个！ | 积极 |

**搜索参数**：
- 迭代次数：5
- 预计 API 调用：5 × 5 = 25 次

### 预期结果

系统会：
1. 自动生成 5 个不同的角色（如：数据分析师、心理学家、客服经理、产品经理、社交媒体专家）
2. 自动生成 5 种风格（如：严谨学术、通俗易懂、简洁明了、详尽全面、系统化）
3. 自动生成 3 种技巧（如：思维链、直接回答、特征分析）
4. 随机组合生成 5 个不同的 Prompt
5. 每个 Prompt 在 5 条测试数据上运行，计算准确率
6. 展示得分最高的 Prompt

### 可能的冠军 Prompt 示例

```
你是一位数据分析师。

任务：对用户评论进行情感分类，判断为积极、消极或中立

风格要求：简洁明了

指令：Provide only the label without explanation

请对以下文本进行分类：
[待分类文本]

只输出分类标签，不要额外解释。
```

**冠军得分**：100.0（5/5 正确）

---

## 🧪 测试样例 2：会议纪要摘要

### 配置信息

**任务类型**：`summarization`（摘要任务）

**任务描述**：
```
将会议记录总结为简洁的摘要，保留关键决策、责任人和时间节点
```

**测试数据集**（至少2条）：

| 测试输入 | 标准答案 |
|---------|---------|
| 2026年1月15日召开产品评审会。会议决定采用方案A开发新功能，由张三负责，预计2周完成。李四提出需要增加测试人员，王五同意提供支持。 | 会议决定：采用方案A，张三负责开发（2周），李四提议增加测试，王五支持。 |
| 技术部门周会讨论了性能优化问题。前端团队完成80%，后端完成60%。王芳遇到兼容性问题，需延期2周。张伟计划引入Redis优化性能。 | 进度：前端80%，后端60%。问题：王芳遇兼容性问题延期2周。优化：张伟引入Redis。 |

**搜索参数**：
- 迭代次数：5
- 预计 API 调用：5 × 2 = 10 次

### 预期结果

可能的冠军 Prompt：

```
你是一位技术文档专家。

任务：将会议记录总结为简洁的摘要，保留关键决策、责任人和时间节点

风格要求：简洁明了

指令：Let's think step by step

请对以下文本进行摘要：
[待摘要文本]

请按照要求输出摘要。
```

**冠军得分**：67.5（ROUGE-1 平均分）

---

## 🧪 测试样例 3：技术术语翻译

### 配置信息

**任务类型**：`translation`（翻译任务）

**任务描述**：
```
将中文技术术语翻译成英文，保持专业性和准确性
```

**测试数据集**（至少2条）：

| 测试输入 | 标准答案 |
|---------|---------|
| 人工智能正在改变世界 | Artificial intelligence is changing the world |
| 机器学习是人工智能的核心技术 | Machine learning is the core technology of artificial intelligence |
| 深度学习在图像识别领域取得突破 | Deep learning has made breakthroughs in image recognition |

**搜索参数**：
- 迭代次数：5
- 预计 API 调用：5 × 3 = 15 次

### 预期结果

可能的冠军 Prompt：

```
你是一位专业技术翻译。

任务：将中文技术术语翻译成英文，保持专业性和准确性

风格要求：严谨学术

指令：Use standard technical terminology

请翻译以下文本：
[待翻译文本]

只输出翻译结果，不要额外说明。
```

**冠军得分**：42.3（BLEU 分数）

---

## 📊 操作步骤

### 方式一：Streamlit 界面测试（推荐）

#### 1. 启动应用
```bash
streamlit run app.py
```

#### 2. 配置 API
- 在侧边栏选择 API 提供商（NVIDIA 或 OpenAI）
- 输入 API Key

#### 3. 滚动到"随机搜索优化"区域
- 在主界面底部找到"🎲 Prompt 随机搜索优化"区域

#### 4. 配置搜索任务
1. 选择任务类型（分类/摘要/翻译）
2. 输入任务描述
3. 编辑测试数据集（可以添加/删除行）
4. 设置迭代次数（建议 5-10 次）

#### 5. 开始搜索
- 点击"🚀 开始随机搜索寻优"按钮
- 等待搜索完成（会显示进度条）

#### 6. 查看结果
- 查看冠军 Prompt 及其得分
- 查看完整搜索记录表格
- 查看得分分布图

#### 7. 使用冠军 Prompt
- 复制冠军 Prompt 文本
- 在验证实验室或实际应用中使用

---

### 方式二：命令行测试（快速验证）

如果你想快速验证功能是否正常，可以使用命令行测试脚本：

```bash
python test_random_search.py
```

**优势**：
- ✅ 无需启动 Streamlit
- ✅ 更详细的调试日志
- ✅ 快速验证功能
- ✅ 适合开发调试

**输出示例**：
```
============================================================
🧪 随机搜索功能测试
============================================================

✅ API 提供商: nvidia
✅ 使用模型: meta/llama-3.1-405b-instruct
✅ API Key: nvapi-xxx...

✅ 优化器初始化成功

📋 测试配置：
  任务类型: classification
  任务描述: 对用户评论进行情感分类（积极/消极/中立）
  测试样本: 3 条
  迭代次数: 3 次
  预计 API 调用: 9 次

------------------------------------------------------------
步骤 1: 生成搜索空间
------------------------------------------------------------
🧠 生成搜索空间
...
✅ 搜索空间生成成功！

------------------------------------------------------------
步骤 2: 执行随机搜索
------------------------------------------------------------
迭代 1/3
  角色: 数据分析师
  风格: 简洁明了
...
```

---

## 💡 使用技巧

### 1. 测试集质量很重要
- ✅ 提供**高质量**、**有代表性**的测试样本
- ✅ 标准答案要准确无误
- ✅ 至少提供 3-5 个测试样本
- ❌ 避免模糊不清的边界案例

### 2. 合理设置迭代次数
- **3-5 次**：快速探索，适合预算有限
- **5-10 次**：平衡性能和成本（推荐）
- **10-15 次**：深度搜索，适合高性能要求

### 3. 控制成本
- 预计消耗 = 迭代次数 × 测试样本数
- 例如：10 次迭代 × 5 个样本 = 50 次 API 调用
- 建议先用少量数据测试，确认效果后再增加

### 4. 理解评分指标
- **分类任务**：准确率（0-100%）
- **摘要任务**：ROUGE-1 分数（0-100%）
- **翻译任务**：BLEU 分数（0-100%）

### 5. 分析搜索结果
- 查看得分分布图，了解不同组合的效果
- 关注排名前 3 的 Prompt，对比其策略组成
- 如果所有 Prompt 得分都很低，可能需要：
  - 改进任务描述
  - 检查测试数据质量
  - 调整评分标准

---

## 🎯 成功案例

### 案例 1：情感分类优化

**初始 Prompt**（人工编写）：
```
请判断以下评论的情感倾向（积极/消极/中立）：
{text}
```
**准确率**：60%

**随机搜索后的最佳 Prompt**：
```
你是一位心理学家。

任务：对用户评论进行情感分类，判断为积极、消极或中立

风格要求：通俗易懂

指令：First analyze the emotional keywords, then make a decision

请对以下文本进行分类：
[待分类文本]

只输出分类标签，不要额外解释。
```
**准确率**：95%

**提升**：+35%

---

## ❓ 常见问题

### Q1: 为什么有时候得分都很低？
A: 可能的原因：
- 测试数据的标准答案与 LLM 输出格式不一致
- 任务描述不够清晰
- 测试样本过于困难或模糊

**解决方法**：
1. 检查标准答案格式（大小写、空格、标点）
2. 优化任务描述，提供更多上下文
3. 替换一些测试样本

### Q2: 搜索过程太慢怎么办？
A: 
- 减少迭代次数（从 10 降到 5）
- 减少测试样本数量（保留最核心的 3-5 个）
- 使用更快的模型（如 llama-3.1-70b 而非 405b）

### Q3: API 调用次数太多了
A:
- 先用 3 次迭代 + 2 个样本测试（共 6 次调用）
- 确认功能正常后，再增加到正式规模
- 使用 NVIDIA API（免费额度充足）

### Q4: 如何验证冠军 Prompt 的效果？
A:
1. 复制冠军 Prompt
2. 去"验证实验室"区域
3. 输入更多测试数据（比搜索时更多）
4. 查看实际表现

---

## 🚀 进阶玩法

### 1. 多次搜索取交集
- 运行 3 次独立的搜索
- 观察哪些策略组合反复出现在前 3 名
- 那些就是真正有效的策略

### 2. 自定义搜索空间
- 修改 `optimizer.py` 中的 `generate_search_space` 函数
- 添加特定领域的角色或技巧
- 例如医疗领域可以添加"临床医生"、"护士"等角色

### 3. 结合人类经验
- 先用随机搜索找到高分组合
- 再人工微调 Prompt 细节
- 将两者优势结合

---

## 📚 参考资料

- [Prompt Engineering Guide](https://www.promptingguide.ai/)
- [Random Search for Hyperparameter Optimization](https://jmlr.org/papers/v13/bergstra12a.html)
- [LangChain Documentation](https://python.langchain.com/)

---

**⭐ 祝您找到最优 Prompt！**
